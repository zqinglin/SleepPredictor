# 睡眠质量预测（多模态：手环/床垫/空气 + 主观评分CSV）

## 数据
- `数据导出/手环{ID}_*.csv`：手环时序数据（心率/血氧/血压/睡眠阶段/睡眠开始结束等）
- `数据导出/智慧床垫{ID}_*.csv`：床垫时序数据（心率/呼吸率/在床状态）
- `数据导出/空气监测{ID}_*.csv`：宿舍共享空气指标（CO2/PM2.5/PM10/甲醛/TVOC/温湿度）
- 根目录四份主观评分CSV：`手环XXXX 床垫YYYY.csv`（每日5项分数：`睡眠平静程度/容易清醒程度/容易入睡程度/醒后振奋程度/睡眠满意程度`）。
  - 需包含列：`日期, 睡眠平静程度, 容易清醒程度, 容易入睡程度, 醒后振奋程度, 睡眠满意程度`
  - `total` 将在训练时自动计算：5项求和/25×100（即100分制）

## 配置
编辑 `src/config.yaml` 配置：
- 人员-设备映射、空气监测设备ID
- 夜间窗口（默认 20:00 → 次日 12:00），训练/推理均按“昨晚窗口”聚合
- 在床取值（默认 3），推理回退时兼容 3 或 4

## 环境
```bash
pip install -r requirements.txt
```

## 训练
```bash
python -m src.train --config src/config.yaml --n_estimators 400
```
输出：
- `models/sleep_model.joblib`
- `models/meta.json`（特征列、目标列、交叉验证MAE）
- `models/cv_mae.json`（各目标的CV-MAE）

## 推理
```bash
# 默认使用最近一晚
python -m src.infer --config src/config.yaml --person person_A

# 指定人员与起床日期（昨晚的下一天）
python -m src.infer --config src/config.yaml --person person_A --date 2025-10-11
```
输出：
- `outputs/prediction_{person}.csv`，包含：
  - 5个维度分、`total`、`sleep_index`（100分制，等同于 total）
  - 客观：`sleep_duration_h`（总睡眠时长，小时）、`sleep_start_hour`（入睡时间，小时）

### 推理日期回退策略
- 先找精确日期；若无 → 回退到不超过该日期的最近一晚；若仍无 → 使用最新一晚（避免0样本错误）

## 客观指标计算（当前实现）
- 统一在 `Asia/Shanghai` 时区下按“昨晚窗口”分夜统计；客观指标的优先级：
  1) 手环“睡眠开始时间/睡眠结束时间”：取每夜最早开始与最晚结束，得到总时长与入睡时间；
  2) 手环分段总和：`浅睡时间+深睡时间+快速眼动时间` 的最大值总和，自动判断单位（小时或分钟）并转为小时；
  3) 床垫“在床”分段总和：`在床垫状态` 兼容 3 或 4 为“在床”，以 15 分钟为阈值切段，求所有在床段的总时长，入睡时间取首段开始。

## 模型与特征（摘要）
- 特征：
  - 手环：心率/血氧/血压/阶段时长/手环评分等的均值/极值
  - 床垫：心率/呼吸率/在床比例与累计
  - 空气：CO2/PM2.5/PM10/甲醛/TVOC/温湿度统计量
- 训练目标：5个维度分 + `total`（100分制）
- 模型：`MultiOutputRegressor(RandomForestRegressor(n_estimators=400))`，KFold交叉验证；指标 MAE（平均绝对误差）

## 常见问题
- 指定的 `--date` 无数据：会自动回退到最近一晚；若仍无，使用最新一晚。
- 某天没戴手环：会回退用床垫数据估算总睡眠时长；若两者都没有数据，该晚无法预测。
- 在床取值：默认按 3 作为在床，同时兼容 3/4；如你的设备在床编码不同，可在 `src/config.yaml` 调整。
